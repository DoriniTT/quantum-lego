# AGENTS.md — GitHub Agentic Workflows

Guide for creating and maintaining gh-aw workflow files in this directory.

## Design Principle: Self-Improving Workflows

Every workflow in this directory is expected to improve itself at the end of each run.
After completing its primary task, the agent reads its own `.md` prompt file, identifies
what could be clearer or more effective based on what it just experienced, edits the file,
recompiles it with `gh aw compile`, and opens a PR with the improvements.

This means each run makes the next run better — tighter instructions, better tool allowlists,
improved output structure — without any manual prompt engineering effort.

## Standard Workflow

```bash
# 1. Write/edit the prompt file
vim my-workflow.md

# 2. Compile (from repo root)
gh aw compile my-workflow

# 3. Commit both files
git add .github/workflows/my-workflow.md .github/workflows/my-workflow.lock.yml
git commit -m "feat: add my-workflow"
git push

# 4. Run (from repo root)
gh aw run my-workflow

# 5. Watch logs
gh run list --workflow=my-workflow.lock.yml --limit=5
gh run view --job=<job-id> --log
```

> **Important:** always run `gh aw compile` and `gh aw run` from the **repo root**, not from inside `.github/workflows/`.
> Never manually edit `.lock.yml` files — `gh aw run` validates a frontmatter hash and will refuse to run a patched lock file.

## File Structure

Every workflow consists of two files:

| File | Purpose | Edit? |
|---|---|---|
| `<name>.md` | Frontmatter config + agent prompt | Yes — and the agent edits it too |
| `<name>.lock.yml` | Auto-generated Actions YAML | No — regenerated by `gh aw compile` |

## Frontmatter Reference

```yaml
---
name: My Workflow                          # Display name in GitHub Actions UI
description: What this workflow does       # One-line description
engine: copilot                            # copilot | codex | claude | custom
strict: true                               # Enforces action pinning, safe-outputs
timeout-minutes: 20                        # Agent execution timeout
on:
  workflow_dispatch:                       # Manual trigger
  # schedule:
  # - cron: 0 9 * * 1-5                  # Weekdays at 9am UTC
  # skip-if-match: is:pr is:open in:title "[my-workflow]"  # Skip if PR already exists
permissions:
  contents: read
  issues: read
  pull-requests: read                      # Required when github.toolsets includes default
network:
  allowed:
  - defaults
  - github
imports:
- shared/reporting.md                      # Report formatting guidelines
steps:
  - name: Disable sparse checkout          # ALWAYS include this when reading source files
    run: |
      git sparse-checkout disable
      git checkout
tools:
  bash:
  - find . -name '*.py' -type f            # Use . not a specific subdir
  - cat **/*.py                            # Glob from repo root
  - "find examples/ -name '*.py' -type f" # Quote patterns with special chars
  edit:                                    # Enable edit tool (for workflows that write files)
  edit: null                               # Disable edit tool (read-only workflows)
  github:
    toolsets:
    - default                              # Requires pull-requests: read permission
    # - issues                             # For issue-only access
    # - labels
  serena:
  - python                                 # Enables semantic Python code analysis
  cache-memory: true                       # Persist memory between runs
safe-outputs:
  create-issue:                            # Agent can create GitHub issues
    title-prefix: "[my-workflow] "
    labels: [report, automated]
    max: 1
tracker-id: my-workflow                    # Unique ID — used for skip-if-match tracking
---
```

### Valid `safe-outputs` types

| Type | Use case | Key fields |
|---|---|---|
| `create-issue` | Analysis reports, review findings | `title-prefix`, `labels`, `max` |
| `create-discussion` | Long-running analysis, daily reports | `category`, `title-prefix`, `close-older-discussions`, `max` |
| `create-pull-request` | Automated code improvements | `title-prefix`, `labels`, `reviewers`, `expires` |
| `add-labels` | Issue triage | `allowed` (list of valid labels) |
| `add-comment` | Inline feedback on issues/PRs | `max` |

### `safe-outputs` with multiple types

When combining multiple output types (e.g. `create-issue` + `create-pull-request`), the `max:` field is **not valid** on either entry — remove it:

```yaml
safe-outputs:
  create-issue:
    title-prefix: "[my-workflow] "
    labels: [report, automated]
  create-pull-request:
    title-prefix: "[my-workflow] "
    labels: [self-improvement, automated]
    reviewers:
    - copilot
```

### Fields that do NOT exist

- `model:` — not a valid frontmatter field; set model via `GH_AW_MODEL_AGENT_COPILOT` variable (see below)
- `source:` — only present in workflows imported from the upstream `github/gh-aw` template library; omit for custom workflows
- `allowed_patterns:` — not valid; use `allowed` inside tool definitions

## Setting the Model

There is no frontmatter field for model selection. Set the `GH_AW_MODEL_AGENT_COPILOT` Actions variable in repo **Settings → Variables → Actions**. This applies to all `engine: copilot` workflows.

```
Settings → Variables → Actions → New repository variable
Name:  GH_AW_MODEL_AGENT_COPILOT
Value: claude-sonnet-4.5
```

If the variable is unset, the Copilot CLI uses its own default model.

### Valid model names (as of Feb 2026)

```
claude-sonnet-4.5   claude-haiku-4.5   claude-opus-4.5   claude-opus-4.6   claude-sonnet-4
gpt-5               gpt-5.1            gpt-5.2            gpt-5-mini
gpt-5.1-codex       gpt-5.1-codex-max  gpt-5.1-codex-mini gpt-5.2-codex
gpt-4.1
gemini-3-pro-preview
```

Note: `gpt-codex-5.3` is **not** a valid name — use `gpt-5.1-codex` or `gpt-5.2-codex`.

## Engine Comparison

| Engine | Secret needed | Model variable | Use when |
|---|---|---|---|
| `copilot` | `COPILOT_GITHUB_TOKEN` | `GH_AW_MODEL_AGENT_COPILOT` | You have a GitHub Copilot subscription |
| `codex` | `CODEX_API_KEY` or `OPENAI_API_KEY` | `GH_AW_MODEL_AGENT_CODEX` | You have a direct OpenAI API key |
| `claude` | `CLAUDE_CODE_OAUTH_TOKEN` | n/a (uses Claude Code) | Claude Code workflows |

## Permissions Gotchas

| Toolset / output | Permission required |
|---|---|
| `github.toolsets: [default]` | `pull-requests: read` |
| `github.toolsets: [issues]` | `issues: read` |
| `safe-outputs: create-issue` | handled by `safe_outputs` job automatically |
| `safe-outputs: create-pull-request` | handled by `safe_outputs` job automatically |
| Reading files via Serena | `contents: read` |

When in doubt, run `gh aw compile --no-emit` — it reports missing permissions as errors.

## Bash Tool Patterns

```yaml
tools:
  bash:
  # CORRECT — glob from repo root
  - cat **/*.py
  - find . -name '*.py' -type f

  # WRONG — specific subdir breaks if structure changes
  - cat quantum_lego/**/*.py        # Don't do this
  - find quantum_lego -name '*.py'  # Don't do this

  # Quote patterns with special characters
  - "find . -name '*.py' ! -path '*/__pycache__/*' -type f"
  - "pytest tests/ -m tier1 -v 2>&1 || true"
```

## Serena MCP Notes

- `serena: ["python"]` enables semantic Python analysis via the Serena MCP server
- The `--context codex` in Serena's startup args is Serena's **IDE assistant mode** — it is not a model name
- In the agent prompt, always call `activate_project` with the workspace path before using other Serena tools:
  ```
  Use activate_project with path: ${{ github.workspace }}
  ```
- Available Serena tools: `read_file`, `get_symbols_overview`, `find_symbol`, `search_for_pattern`, `find_referencing_symbols`
- `edit: null` disables the edit tool when Serena is available for reading (cleaner permissions)

## Self-Improvement Pattern

Every workflow should include a final phase that improves itself. Add this to the end of every prompt:

```markdown
## Phase N: Self-Improve This Workflow

After completing all primary tasks, improve this workflow's prompt for future runs.

### Read the current prompt
\```bash
cat .github/workflows/<name>.md
\```

### Identify improvements
Based on this run, look for:
- Commands needed but not in the allowed tools list
- Instructions that were unclear or caused backtracking
- Missing context about repo structure
- Output format improvements
Only change what genuinely needs improving.

### Apply edits
Use the edit tool to update `.github/workflows/<name>.md` directly.

### Regenerate the lock file
\```bash
gh aw compile <name>
\```
If unavailable, skip and note it in the PR.

### Create a self-improvement pull request
Create a PR with the updated `.md` (and `.lock.yml` if compile succeeded).
PR body must list exactly what changed and why, and confirm run `${{ github.run_id }}`.
```

To enable this pattern, the workflow frontmatter needs:

```yaml
timeout-minutes: 30          # extra time for self-improvement phase
steps:
  - name: Disable sparse checkout
    run: |
      git sparse-checkout disable
      git checkout
  - name: Install gh-aw for self-compilation
    run: gh extension install github/gh-aw 2>/dev/null || true
tools:
  bash:
  - cat .github/workflows/<name>.md   # read own prompt
  - gh aw compile <name>              # recompile after edits
  - git add .github/workflows/
  - "git commit:*"
  - "git branch:*"
  - "git checkout:*"
  - git status
  edit:                               # must be enabled (not null) to write files
safe-outputs:
  create-issue:                       # primary output
    title-prefix: "[<name>] "
    labels: [report, automated]
  create-pull-request:                # self-improvement output
    title-prefix: "[<name>] "
    labels: [self-improvement, automated]
    reviewers:
    - copilot
```

## Workflow Checklist

When creating a new workflow:

- [ ] Write `<name>.md` with correct frontmatter
- [ ] Include self-improvement phase (see pattern above)
- [ ] Include `steps: Disable sparse checkout` + `Install gh-aw for self-compilation`
- [ ] Ensure `edit:` is enabled (not `edit: null`) so the agent can write files
- [ ] Add `cat .github/workflows/<name>.md` and `gh aw compile <name>` to bash tools
- [ ] Add both `create-issue` and `create-pull-request` to `safe-outputs` (no `max:` field when combining)
- [ ] Run `gh aw compile <name>` from repo root — fix any errors/warnings
- [ ] Commit both `<name>.md` and `<name>.lock.yml`
- [ ] Push to remote
- [ ] Run: `gh aw run <name>` from repo root
- [ ] Check logs: `gh run list --workflow=<name>.lock.yml --limit=1`
