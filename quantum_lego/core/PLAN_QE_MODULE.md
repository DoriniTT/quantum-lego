 Plan to implement                                                                                                                                                                                           │
│                                                                                                                                                                                                             │
│ Plan: Add QE (Quantum ESPRESSO) Brick to Lego Module                                                                                                                                                        │
│                                                                                                                                                                                                             │
│ Summary                                                                                                                                                                                                     │
│                                                                                                                                                                                                             │
│ Add a qe brick type wrapping PwBaseWorkChain from aiida-quantumespresso, plus a standalone quick_qe() and quick_qe_sequential() convenience functions. Minimal first version: SCF, relax, vc-relax with     │
│ restart chaining. No selective dynamics or supercell support initially.                                                                                                                                     │
│                                                                                                                                                                                                             │
│ Design Decisions                                                                                                                                                                                            │
│                                                                                                                                                                                                             │
│ - Separate quick_qe_sequential() instead of extending quick_vasp_sequential (no mixed VASP+QE pipelines)                                                                                                    │
│ - No default pseudo_family -- always require explicit specification                                                                                                                                         │
│ - Minimal scope -- no fix_type, fix_thickness, or supercell support in v1                                                                                                                                   │
│                                                                                                                                                                                                             │
│ ---                                                                                                                                                                                                         │
│ Files to Create                                                                                                                                                                                             │
│                                                                                                                                                                                                             │
│ 1. teros/core/lego/bricks/qe.py                                                                                                                                                                             │
│                                                                                                                                                                                                             │
│ The QE brick module with the standard 5-function interface.                                                                                                                                                 │
│                                                                                                                                                                                                             │
│ validate_stage(stage, stage_names) -- checks:                                                                                                                                                               │
│ - parameters field required (QE namelists dict: CONTROL, SYSTEM, ELECTRONS, etc.)                                                                                                                           │
│ - restart field required (None or previous stage name)                                                                                                                                                      │
│ - structure_from validation (same logic as VASP: 'previous', 'input', or stage name)                                                                                                                        │
│                                                                                                                                                                                                             │
│ create_stage_tasks(wg, stage, stage_name, context) -- creates:                                                                                                                                              │
│ - Wraps PwBaseWorkChain via task(WorkflowFactory('quantumespresso.pw.base'))                                                                                                                                │
│ - Resolves structure (same pattern as VASP brick)                                                                                                                                                           │
│ - Resolves pseudopotentials from pseudo_family using aiida-pseudo's PseudoPotentialFamily.get_pseudos(structure=...)                                                                                        │
│ - Handles restart via pw.parent_folder input (from previous QE stage's remote_folder)                                                                                                                       │
│ - Adds extract_qe_energy task                                                                                                                                                                               │
│ - Returns {'qe': qe_task, 'energy': energy_task, 'input_structure': structure}                                                                                                                              │
│                                                                                                                                                                                                             │
│ Key input mapping for PwBaseWorkChain via wg.add_task():                                                                                                                                                    │
│ qe_kwargs = {                                                                                                                                                                                               │
│     'pw__structure': stage_structure,                                                                                                                                                                       │
│     'pw__code': code,                                                                                                                                                                                       │
│     'pw__parameters': orm.Dict(dict=parameters),                                                                                                                                                            │
│     'pw__pseudos': pseudos,          # Dict of element -> UpfData                                                                                                                                           │
│     'pw__metadata': {'options': options},                                                                                                                                                                   │
│     'kpoints_distance': orm.Float(spacing),  # or kpoints=KpointsData                                                                                                                                       │
│     'clean_workdir': orm.Bool(clean_workdir),                                                                                                                                                               │
│ }                                                                                                                                                                                                           │
│                                                                                                                                                                                                             │
│ expose_stage_outputs -- exposes {ns}.qe.energy, {ns}.qe.structure (from output_structure), {ns}.qe.output_parameters, {ns}.qe.remote, {ns}.qe.retrieved                                                     │
│                                                                                                                                                                                                             │
│ get_stage_results -- extracts energy, structure, output_parameters, remote, retrieved from WorkGraph node (same traversal pattern as VASP)                                                                  │
│                                                                                                                                                                                                             │
│ print_stage_results -- formatted output showing energy, structure formula, Fermi energy, forces                                                                                                             │
│                                                                                                                                                                                                             │
│ 2. examples/lego/qe/run_qe_si.py                                                                                                                                                                            │
│                                                                                                                                                                                                             │
│ Example script showing:                                                                                                                                                                                     │
│ 1. Single QE SCF with quick_qe()                                                                                                                                                                            │
│ 2. Sequential QE relax -> SCF with quick_qe_sequential()                                                                                                                                                    │
│                                                                                                                                                                                                             │
│ ---                                                                                                                                                                                                         │
│ Files to Modify                                                                                                                                                                                             │
│                                                                                                                                                                                                             │
│ 3. teros/core/lego/bricks/connections.py                                                                                                                                                                    │
│                                                                                                                                                                                                             │
│ Add QE_PORTS:                                                                                                                                                                                               │
│ QE_PORTS = {                                                                                                                                                                                                │
│     'inputs': {                                                                                                                                                                                             │
│         'structure': {                                                                                                                                                                                      │
│             'type': 'structure',                                                                                                                                                                            │
│             'required': True,                                                                                                                                                                               │
│             'source': 'auto',                                                                                                                                                                               │
│             'description': 'Atomic structure for QE pw.x calculation',                                                                                                                                      │
│         },                                                                                                                                                                                                  │
│         'restart_folder': {                                                                                                                                                                                 │
│             'type': 'remote_folder',                                                                                                                                                                        │
│             'required': False,                                                                                                                                                                              │
│             'source': 'restart',                                                                                                                                                                            │
│             'description': 'Remote folder for parent_folder restart',                                                                                                                                       │
│         },                                                                                                                                                                                                  │
│     },                                                                                                                                                                                                      │
│     'outputs': {                                                                                                                                                                                            │
│         'structure': {                                                                                                                                                                                      │
│             'type': 'structure',                                                                                                                                                                            │
│             'conditional': {                                                                                                                                                                                │
│                 'config_path': ['parameters', 'CONTROL', 'calculation'],                                                                                                                                    │
│                 'operator': 'in',                                                                                                                                                                           │
│                 'value': ['relax', 'vc-relax'],                                                                                                                                                             │
│             },                                                                                                                                                                                              │
│             'description': 'Relaxed structure (only if calculation is relax or vc-relax)',                                                                                                                  │
│         },                                                                                                                                                                                                  │
│         'energy': {'type': 'energy', 'description': 'Total energy (eV)'},                                                                                                                                   │
│         'output_parameters': {'type': 'misc', 'description': 'Parsed QE output dict'},                                                                                                                      │
│         'remote_folder': {'type': 'remote_folder', 'description': 'Remote calc directory'},                                                                                                                 │
│         'retrieved': {'type': 'retrieved', 'description': 'Retrieved files'},                                                                                                                               │
│     },                                                                                                                                                                                                      │
│ }                                                                                                                                                                                                           │
│                                                                                                                                                                                                             │
│ Register in ALL_PORTS: Add 'qe': QE_PORTS                                                                                                                                                                   │
│                                                                                                                                                                                                             │
│ Extend _evaluate_conditional(): Add config_path support (list of keys for nested dict traversal) alongside existing incar_key. Add 'in' operator.                                                           │
│                                                                                                                                                                                                             │
│ 4. teros/core/lego/tasks.py                                                                                                                                                                                 │
│                                                                                                                                                                                                             │
│ Add extract_qe_energy calcfunction:                                                                                                                                                                         │
│ @task.calcfunction                                                                                                                                                                                          │
│ def extract_qe_energy(output_parameters: orm.Dict) -> orm.Float:                                                                                                                                            │
│     params = output_parameters.get_dict()                                                                                                                                                                   │
│     if 'energy' in params:                                                                                                                                                                                  │
│         return orm.Float(float(params['energy']))                                                                                                                                                           │
│     raise ValueError(f'No energy in QE output. Keys: {sorted(params.keys())}')                                                                                                                              │
│                                                                                                                                                                                                             │
│ 5. teros/core/lego/bricks/__init__.py                                                                                                                                                                       │
│                                                                                                                                                                                                             │
│ - Import and register qe in BRICK_REGISTRY                                                                                                                                                                  │
│ - Update resolve_structure_from() to handle ref_stage_type == 'qe' (use outputs.output_structure)                                                                                                           │
│                                                                                                                                                                                                             │
│ 6. teros/core/lego/workgraph.py                                                                                                                                                                             │
│                                                                                                                                                                                                             │
│ Add quick_qe() function -- single QE calculation (mirrors quick_vasp()):                                                                                                                                    │
│ def quick_qe(                                                                                                                                                                                               │
│     structure, code_label, parameters, kpoints_spacing,                                                                                                                                                     │
│     pseudo_family, options, kpoints=None, restart_from=None,                                                                                                                                                │
│     name='quick_qe', wait=False, poll_interval=10.0, clean_workdir=False,                                                                                                                                   │
│ ) -> int:                                                                                                                                                                                                   │
│                                                                                                                                                                                                             │
│ Add quick_qe_sequential() function -- multi-stage QE pipeline (mirrors quick_vasp_sequential()):                                                                                                            │
│ def quick_qe_sequential(                                                                                                                                                                                    │
│     structure, stages, code_label, kpoints_spacing,                                                                                                                                                         │
│     pseudo_family, options, max_concurrent_jobs=None,                                                                                                                                                       │
│     name='quick_qe_sequential', wait=False, poll_interval=10.0,                                                                                                                                             │
│     clean_workdir=False,                                                                                                                                                                                    │
│ ) -> dict:                                                                                                                                                                                                  │
│                                                                                                                                                                                                             │
│ Context dict for QE sequential:                                                                                                                                                                             │
│ context = {                                                                                                                                                                                                 │
│     'code': code,                                                                                                                                                                                           │
│     'pseudo_family': pseudo_family,                                                                                                                                                                         │
│     'options': options,                                                                                                                                                                                     │
│     'base_kpoints_spacing': kpoints_spacing,                                                                                                                                                                │
│     'clean_workdir': clean_workdir,                                                                                                                                                                         │
│     'stage_tasks': {}, 'stage_types': {}, 'stage_names': [],                                                                                                                                                │
│     'stages': stages, 'input_structure': structure, 'stage_index': i,                                                                                                                                       │
│ }                                                                                                                                                                                                           │
│                                                                                                                                                                                                             │
│ 7. teros/core/lego/__init__.py                                                                                                                                                                              │
│                                                                                                                                                                                                             │
│ Export quick_qe, quick_qe_sequential.                                                                                                                                                                       │
│                                                                                                                                                                                                             │
│ 8. tests/test_lego_connections.py                                                                                                                                                                           │
│                                                                                                                                                                                                             │
│ Add tests:                                                                                                                                                                                                  │
│ - QE port types recognized in PORT_TYPES                                                                                                                                                                    │
│ - QE outputs count and names                                                                                                                                                                                │
│ - validate_connections() passes for single QE stage, two QE stages, QE chain                                                                                                                                │
│ - validate_connections() rejects QE restart from nonexistent stage                                                                                                                                          │
│ - Conditional: QE relax produces structure (no warning), QE scf warns                                                                                                                                       │
│ - config_path conditional evaluation tests                                                                                                                                                                  │
│                                                                                                                                                                                                             │
│ 9. tests/test_lego_bricks.py                                                                                                                                                                                │
│                                                                                                                                                                                                             │
│ Add TestQeBrickValidateStage:                                                                                                                                                                               │
│ - Valid QE stage passes                                                                                                                                                                                     │
│ - Missing parameters raises                                                                                                                                                                                 │
│ - Missing restart raises                                                                                                                                                                                    │
│ - Restart referencing nonexistent stage raises                                                                                                                                                              │
│ - Invalid structure_from raises                                                                                                                                                                             │
│                                                                                                                                                                                                             │
│ 10. CLAUDE.md                                                                                                                                                                                               │
│                                                                                                                                                                                                             │
│ - Module structure tree: add qe.py under bricks/                                                                                                                                                            │
│ - Brick types table: add qe row                                                                                                                                                                             │
│ - Key functions table: add quick_qe(), quick_qe_sequential()                                                                                                                                                │
│ - Add QE stage configuration docs                                                                                                                                                                           │
│                                                                                                                                                                                                             │
│ ---                                                                                                                                                                                                         │
│ QE Stage Configuration Schema                                                                                                                                                                               │
│                                                                                                                                                                                                             │
│ {                                                                                                                                                                                                           │
│     'name': str,                     # Required, unique                                                                                                                                                     │
│     'type': 'qe',                    # Required                                                                                                                                                             │
│     'parameters': {                  # Required, QE namelists                                                                                                                                               │
│         'CONTROL': {'calculation': 'scf'},                                                                                                                                                                  │
│         'SYSTEM': {'ecutwfc': 50, 'ecutrho': 400},                                                                                                                                                          │
│         'ELECTRONS': {'conv_thr': 1e-8},                                                                                                                                                                    │
│         'IONS': {},     # Optional, for relax                                                                                                                                                               │
│         'CELL': {},     # Optional, for vc-relax                                                                                                                                                            │
│     },                                                                                                                                                                                                      │
│     'restart': None | str,           # Required (None or previous stage name)                                                                                                                               │
│     'structure_from': str,           # Optional ('previous', 'input', or stage name)                                                                                                                        │
│     'kpoints_spacing': float,        # Optional, override default                                                                                                                                           │
│     'kpoints': [nx, ny, nz],         # Optional, explicit mesh                                                                                                                                              │
│     'pseudo_family': str,            # Optional, override default                                                                                                                                           │
│     'code_label': str,               # Optional, override default                                                                                                                                           │
│ }                                                                                                                                                                                                           │
│                                                                                                                                                                                                             │
│ ---                                                                                                                                                                                                         │
│ Implementation Order                                                                                                                                                                                        │
│                                                                                                                                                                                                             │
│ 1. connections.py -- QE_PORTS + conditional extension                                                                                                                                                       │
│ 2. tests/test_lego_connections.py -- QE port/connection tests (run tier1)                                                                                                                                   │
│ 3. tasks.py -- extract_qe_energy calcfunction                                                                                                                                                               │
│ 4. bricks/qe.py -- full brick module                                                                                                                                                                        │
│ 5. bricks/__init__.py -- register + update resolvers                                                                                                                                                        │
│ 6. tests/test_lego_bricks.py -- validate_stage tests                                                                                                                                                        │
│ 7. workgraph.py -- quick_qe() + quick_qe_sequential()                                                                                                                                                       │
│ 8. lego/__init__.py -- exports                                                                                                                                                                              │
│ 9. examples/lego/qe/run_qe_si.py -- example script                                                                                                                                                          │
│ 10. CLAUDE.md -- documentation                                                                                                                                                                              │
│                                                                                                                                                                                                             │
│ Verification                                                                                                                                                                                                │
│                                                                                                                                                                                                             │
│ # Tier 1 tests (no AiiDA daemon needed)                                                                                                                                                                     │
│ pytest tests/test_lego_connections.py -v                                                                                                                                                                    │
│ pytest tests/test_lego_bricks.py -v                                                                                                                                                                         │
│                                                                                                                                                                                                             │
│ # Lint                                                                                                                                                                                                      │
│ flake8 teros/core/lego/bricks/ --max-line-length=120 --ignore=E501,W503,E402,F401                                                                                                                           │
│                                                                                                                                                                                                             │
│ # Local test (requires QE code configured in AiiDA)                                                                                                                                                         │
│ # verdi daemon restart                                                                                                                                                                                      │
│ # python examples/lego/qe/run_qe_si.py                                                                                                                                                                      │
│ # verdi process show <PK>
